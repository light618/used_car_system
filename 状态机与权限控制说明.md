# 车源状态机与权限控制说明

## 状态流转图

```
待上架（待审核）
  ↓ [审核通过]
待出售
  ↓ [预定] 或 [直接出售]
已预定 或 已售出
```

## 详细状态说明

### 1. 待上架（待审核）
**状态值：** `待上架` 或 `待审核`（等同）

**可见范围：**
- 仅录入机构可见
  - 总部录入（store_id=0）→ 仅总部可见
  - 门店A录入（store_id=A）→ 仅门店A可见

**可操作人员：**
- 录入人：可编辑
- 本机构审核员（总部管理员/门店管理员）：可审核/驳回

**状态流转：**
- 审核通过 → `待出售`
- 审核驳回 → `待上架`（可重新编辑）

**权限控制：**
- 列表查询：强制按 `store_id` 过滤，排除授权车源
- 详情查看：检查 `store_id` 是否匹配当前用户机构
- 编辑：仅录入人可编辑
- 审核：仅本机构审核员可审核

---

### 2. 待出售
**状态值：** `待出售`

**可见范围：**
- 总部（始终可见）
- 收车机构（store_id 匹配）
- 被授权门店（通过 `uc_car_authorizations` 查询）

**授权规则：**
- 授权操作者：总部 或 收车机构
- 授权范围：除收车机构和总部以外的所有门店
- 说明：收车机构本身就有权限，总部也有权限，不需要额外授权

**可操作：**
- 预定：所有可见机构都可预定
- 出售：所有可见机构都可直接出售（无需先预定）
- 授权：总部/收车机构可授权给其他门店

**状态流转：**
- 预定 → `已预定`
- 直接出售 → `已售出`

**权限控制：**
- 列表查询：总部看全部；门店看本店+授权车源
- 详情查看：总部/收车机构/被授权门店可见
- 预定：所有可见机构都可预定
- 出售：所有可见机构都可出售
- 授权：仅总部/收车机构可授权

---

### 3. 已预定
**状态值：** `已预定`

**可见范围：**
- 总部（始终可见）
- 收车机构（store_id 匹配）
- 被授权门店（通过 `uc_car_authorizations` 查询）

**可操作：**
- 预定门店：可取消预定、可出售
- 其他机构：不可操作（仅可见）

**状态流转：**
- 取消预定 → `待出售`
- 出售 → `已售出`

**权限控制：**
- 列表查询：总部看全部；门店看本店+授权车源
- 详情查看：总部/收车机构/被授权门店可见
- 取消预定：仅预定门店（reserved_store_id 匹配）可取消
- 出售：仅预定门店可出售

---

### 4. 已售出
**状态值：** `已售出`

**可见范围：**
- 总部（始终可见）
- 收车机构（store_id 匹配）
- 被授权门店（通过 `uc_car_authorizations` 查询）

**可操作：**
- 只读（所有机构都不可操作）

**权限控制：**
- 列表查询：总部看全部；门店看本店+授权车源
- 详情查看：总部/收车机构/被授权门店可见
- 操作：无（只读）

---

## 权限矩阵

| 状态 | 总部 | 收车机构 | 被授权门店 | 其他门店 |
|------|------|----------|------------|----------|
| 待上架 | ✅（仅总部录入） | ✅（仅本店录入） | ❌ | ❌ |
| 待出售 | ✅ 可授权/预定/出售 | ✅ 可授权/预定/出售 | ✅ 可预定/出售 | ❌ |
| 已预定 | ✅ 可见 | ✅ 可见 | ✅ 可见 | ❌ |
| 已售出 | ✅ 只读 | ✅ 只读 | ✅ 只读 | ❌ |

## 关键权限点

1. **待上架强制隔离**：列表查询时，若状态为"待上架/待审核"，强制按 `store_id` 过滤，排除授权逻辑
2. **授权范围**：授权时排除收车机构（store_id）和总部（0）
3. **预定锁定**：已预定时，仅预定门店可操作
4. **可见性**：待出售/已预定/已售出状态，总部+收车机构+被授权门店可见

